<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Security Headers -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com;
  style-src 'self' 'unsafe-inline' https://unpkg.com;
  img-src 'self' data: blob:;
  connect-src 'self' https://nnsqmeigtgewatameexo.supabase.co https://api.emailjs.com;
  font-src 'self' https://cdnjs.cloudflare.com;
  frame-src 'none';
  object-src 'none';
  base-uri 'self';
">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <title>Control de Consumo de Agua</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ESTILOS GENERALES Y DE UI */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 50%, #14b8a6 100%);
      min-height: 100%; padding: 0; color: #0f172a;
    }
    .app-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .app-header { background: white; border-radius: 16px; padding: 24px 32px; margin-bottom: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); }
    .app-title { font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: #e6fffa; color: #047857; border-radius: 12px; font-size: 13px; font-weight: 500; }
    .status-dot { width: 6px; height: 6px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Navegaci√≥n */
    .nav-tabs { display: flex; gap: 8px; background: white; padding: 8px; border-radius: 12px; margin-bottom: 24px; overflow-x: auto; }
    .nav-tab { padding: 12px 24px; border: none; background: transparent; color: #4a5568; font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.3s; white-space: nowrap; }
    .nav-tab.active { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); color: white; box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4); }

    /* Tarjetas y Formularios */
    .card { background: white; border-radius: 24px; padding: 32px; margin-bottom: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: fadeInUp 0.5s ease; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .card-header { font-size: 20px; font-weight: 700; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px; }
    
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-size: 14px; font-weight: 600; color: #4a5568; }
    .form-group input, .form-group select, .form-group textarea { padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; width: 100%; transition: 0.3s; }
    .form-group input:focus { border-color: #0ea5e9; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15); outline: none; }
    .form-group input[readonly] { background: #f7fafc; color: #718096; }

    /* Botones */
    .btn { padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; justify-content: center; transition: 0.3s; }
    .btn:hover { transform: translateY(-2px); }
    .btn-primary { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); color: white; }
    .btn-secondary { background: #f1f5f9; color: #475569; }
    .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
    .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
    .btn-whatsapp { background: #25D366; color: white; }
    .btn-whatsapp:hover { background: #128C7E; }
    .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; }

    /* Tablas */
    .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); color: white; }
    th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    .status-pill { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .status-pendiente { background: #fef3c7; color: #92400e; }
    .status-pagado { background: #d1fae5; color: #065f46; }
    .status-mora { background: #fee2e2; color: #991b1b; }

    /* Upload Zones */
    .photo-upload-zone { border: 3px dashed #cbd5e0; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; background: #f7fafc; transition: 0.3s; }
    .photo-upload-zone:hover { border-color: #0ea5e9; background: #f0f9ff; }
    .photo-preview { max-width: 100%; max-height: 250px; border-radius: 12px; margin-top: 16px; display: none; }

    /* Dashboard & Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px; }
    .stat-card { background: white; padding: 24px; border-radius: 20px; color: white; box-shadow: 0 8px 24px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
    .stat-value { font-size: 28px; font-weight: 700; margin-top: 8px; }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 32px; border-radius: 16px; width: 100%; max-width: 500px; animation: modalSlideUp 0.3s ease; }
    @keyframes modalSlideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Ocultar secciones */
    .section { display: none; }
    .section.active { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Login */
    #login-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 50%, #14b8a6 100%);
      z-index: 2000;
      display: none; 
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      text-align: center;
    }
    .login-box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(5px);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
      color: #0f172a;
    }
    .login-box h2 { font-size: 28px; margin-bottom: 20px; }
    .login-box input { padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; width: 100%; margin-bottom: 20px; font-size: 16px; }
    .login-box button { width: 100%; padding: 15px; font-size: 18px; }

    /* Responsive */
    @media (max-width: 768px) {
      .app-header { padding: 16px; }
      .nav-tabs { flex-wrap: nowrap; }
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
 </head>
 <body>
  
  <div id="login-screen">
    <div class="login-box">
      <h2>üîê Secure System Access</h2>
      <p style="margin-bottom: 20px; color: #64748b;">Enter your credentials to continue</p>
      <input type="email" id="login-email" placeholder="Email Address" onkeypress="if(event.keyCode == 13) login()">
      <input type="password" id="login-password" placeholder="Password" onkeypress="if(event.keyCode == 13) login()">
      <button class="btn btn-primary" onclick="login()">Secure Login</button>
      <p id="login-error" style="color: #ef4444; margin-top: 15px; font-weight: 600; display: none;"></p>
    </div>
  </div>

  <div id="app-content-wrapper" style="display:none;">
    <div class="app-container">
    <div class="app-header">
        <div class="app-title">
        <svg style="width: 32px; height: 32px;" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
        <span>Control de Agua Potable</span>
        </div>
        <div class="app-subtitle" style="margin-top: 8px;">
        <span class="status-badge"><span class="status-dot"></span> Supabase Conectado</span>
        <span class="status-badge">üìß EmailJS Activo</span>
        <span class="status-badge" style="background:#dcfce7; color:#166534">üì± WhatsApp</span>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active operator-only" onclick="showSection('clientes')">üë• Clientes</button>
        <button class="nav-tab operator-only" onclick="showSection('lecturas')">üíß Nueva Lectura</button>
        <button class="nav-tab viewer-only" onclick="showSection('tabla')">üìã Historial</button>
        <button class="nav-tab viewer-only" onclick="showSection('dashboard')">üìä Dashboard</button>
        <button class="nav-tab viewer-only" onclick="showSection('mapa')">üó∫Ô∏è Mapa</button>
        <button class="nav-tab admin-only" onclick="showSection('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
    </div>

    <div id="section-clientes" class="section active">
        <div class="card">
        <div class="card-header">Registrar Nuevo Cliente</div>
        <div class="form-grid">
            <div class="form-group"><label>Nombre Completo</label><input type="text" id="nuevo-cliente-nombre" placeholder="Ej. Juan P√©rez"></div>
            <div class="form-group"><label>C√≥digo</label><input type="text" id="nuevo-cliente-codigo" placeholder="Ej. CLI-001"></div>
            <div class="form-group"><label>Medidor</label><input type="text" id="nuevo-cliente-medidor" placeholder="Ej. MED-123456"></div>
            <div class="form-group"><label>Email</label><input type="email" id="nuevo-cliente-email" placeholder="cliente@email.com"></div>
            <div class="form-group"><label>Direcci√≥n</label><input type="text" id="nuevo-cliente-direccion"></div>
            <div class="form-group"><label>Tel√©fono (con o sin c√≥digo pa√≠s)</label><input type="tel" id="nuevo-cliente-telefono" placeholder="Ej. 55551234"></div>
            <div class="form-group"><label>Tarifa Consumo (Q/m¬≥)</label><input type="number" id="nuevo-cliente-tarifa" value="3.00" step="0.01"></div>
            <div class="form-group"><label>Canon Fijo (Q)</label><input type="number" id="nuevo-cliente-canon" value="20.00" step="0.01"></div>
            <div class="form-group"><label>Lectura Inicial</label><input type="number" id="nuevo-cliente-lectura-inicial" value="0"></div>
        </div>
        <div class="btn-group operator-only">
            <button class="btn btn-primary" onclick="agregarCliente()" id="btn-guardar-cliente">üíæ Guardar Cliente</button>
            <button class="btn btn-secondary" onclick="limpiarFormularioCliente()">Limpiar</button>
        </div>
        </div>

        <div class="card">
        <div class="card-header">Directorio de Clientes (<span id="total-clientes">0</span>)</div>
        <input type="text" id="buscar-cliente" placeholder="Buscar..." onkeyup="actualizarListaClientes()" style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:10px; margin-bottom:15px;">
        <div id="lista-clientes" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:15px;">
            </div>
        </div>
    </div>

    <div id="section-lecturas" class="section">
        <div id="route-control" style="background:#f0fdf4; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid #bbf7d0; display:flex; justify-content:space-between; align-items:center;">
        <span id="route-status-text" style="color:#166534; font-weight:600;">Modo Manual</span>
        <button class="btn btn-secondary" onclick="toggleRuta()" id="btn-ruta">üöÄ Iniciar Ruta</button>
        </div>

        <div class="card">
        <div class="card-header">Ingreso de Lectura</div>
        <div class="form-group" style="margin-bottom:20px;">
            <label>Seleccionar Cliente</label>
            <select id="lectura-cliente-select" onchange="seleccionarClienteLectura()">
            <option value="">-- Buscar Cliente --</option>
            </select>
        </div>

        <div id="lectura-detalles" style="display:none;">
            <div style="background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #e2e8f0; display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
                <div><small style="color:#64748b">Cliente</small><div style="font-weight:700" id="info-nombre">-</div></div>
                <div><small style="color:#64748b">Medidor</small><div style="font-weight:700" id="info-medidor">-</div></div>
                <div><small style="color:#64748b">√öltima Lectura</small><div style="font-weight:700" id="info-ultima-lectura">0</div></div>
                <div><small style="color:#64748b">Tarifas</small><div style="font-size:13px">Consumo: Q<span id="info-tarifa"></span> | Canon: Q<span id="info-canon"></span></div></div>
            </div>

            <div class="form-grid">
            <div class="form-group">
                <label>Lectura Actual</label>
                <input type="number" id="lectura-actual" step="0.01" oninput="calcularConsumo()" placeholder="Ingrese lectura del medidor">
            </div>
            <div class="form-group">
                <label>Consumo Calculado (m¬≥)</label>
                <input type="text" id="lectura-consumo" readonly style="font-weight:bold; color:#0ea5e9;">
            </div>
            <div class="form-group">
                <label>Monto Estimado (Q)</label>
                <input type="text" id="lectura-monto-est" readonly style="font-weight:bold; color:#166534; background:#f0fdf4;">
            </div>
            <div class="form-group">
                <label>Mes Facturaci√≥n</label>
                <select id="lectura-mes">
                <option value="auto">Mes Actual</option>
                <option value="1">Enero</option> <option value="2">Febrero</option> <option value="3">Marzo</option>
                <option value="4">Abril</option> <option value="5">Mayo</option> <option value="6">Junio</option>
                <option value="7">Julio</option> <option value="8">Agosto</option> <option value="9">Septiembre</option>
                <option value="10">Octubre</option> <option value="11">Noviembre</option> <option value="12">Diciembre</option>
                </select>
            </div>
            <div class="form-group">
                <label>Estado Pago</label>
                <select id="lectura-estado"><option value="pendiente">Pendiente</option><option value="pagado">Pagado</option><option value="mora">Mora</option></select>
            </div>
            <div class="form-group" style="grid-column: 1/-1;">
                <label>Observaciones</label>
                <input type="text" id="lectura-notas" placeholder="Opcional">
            </div>
            </div>

            <div class="form-grid">
            <div>
                <button class="btn btn-warning" style="width:100%; margin-bottom:10px;" onclick="obtenerGPS()" id="btn-gps">üìç Obtener GPS</button>
                <div id="gps-display" style="display:none; text-align:center; font-size:13px; color:#166534; background:#dcfce7; padding:8px; border-radius:8px;"></div>
            </div>
            <div class="photo-upload-zone" onclick="document.getElementById('photo-input').click()">
                <input type="file" id="photo-input" accept="image/*" capture="environment" hidden onchange="handlePhoto(event)">
                <div id="photo-placeholder">üì∑ Tocar para foto</div>
                <img id="photo-preview" class="photo-preview">
            </div>
            </div>

            <div class="btn-group operator-only">
            <button class="btn btn-primary" onclick="agregarLectura()" id="btn-guardar-lectura">üíæ Guardar Lectura</button>
            <button class="btn btn-secondary" onclick="limpiarFormularioLectura()">Cancelar</button>
            </div>
        </div>
        </div>
    </div>

    <div id="section-tabla" class="section">
        <div class="card">
        <div class="card-header" style="display:flex; justify-content:space-between; flex-wrap:wrap;">
            <span>Historial de Lecturas</span>
            <button class="btn btn-secondary" onclick="exportarPDFGlobal()">üìÑ PDF Reporte</button>
        </div>
        
        <div style="background:#f8fafc; padding:15px; margin-bottom:20px; border-radius:12px; border:1px solid #e2e8f0; display:flex; gap:10px; flex-wrap:wrap;">
            <input type="text" id="filtro-texto" placeholder="Buscar..." onkeyup="aplicarFiltros()" style="padding:8px; border-radius:8px; border:1px solid #cbd5e0;">
            <select id="filtro-estado" onchange="aplicarFiltros()" style="padding:8px; border-radius:8px; border:1px solid #cbd5e0;">
            <option value="">Todos los Estados</option>
            <option value="pendiente">Pendiente</option>
            <option value="pagado">Pagado</option>
            <option value="mora">Mora</option>
            </select>
        </div>

        <div class="table-container">
            <table id="tabla-registros">
            <thead>
                <tr>
                <th>Fecha</th> <th>Cliente</th> <th>Lect. Ant.</th> <th>Lect. Act.</th> <th>Consumo</th> <th>Total (Q)</th> <th>Estado</th> <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
            </table>
        </div>
        </div>
    </div>

    <div id="section-dashboard" class="section">
        <div class="stats-grid">
        <div class="stat-card" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);">
            <div class="stat-label">Consumo Mes (m¬≥)</div>
            <div class="stat-value" id="dash-consumo">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <div class="stat-label">Recaudo Estimado (Q)</div>
            <div class="stat-value" id="dash-dinero">0.00</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <div class="stat-label">Pendientes de Pago</div>
            <div class="stat-value" id="dash-pendientes">0</div>
        </div>
        </div>
        <div class="card" style="margin-top:24px;">
            <div class="card-header">Tendencias</div>
            <div style="height:300px;"><canvas id="chart-consumo"></canvas></div>
        </div>
    </div>

    <div id="section-mapa" class="section">
        <div class="card" style="height: 600px; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
          <div style="padding: 15px 20px; background: white; border-bottom: 1px solid #e2e8f0; z-index: 500; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 18px;">Geolocalizaci√≥n de Medidores</h3>
            <div>
               <span class="status-badge" style="background:#fee2e2; color:#991b1b">üî¥ Mora</span>
               <span class="status-badge" style="background:#fef3c7; color:#92400e">üü° Pendiente</span>
               <span class="status-badge" style="background:#d1fae5; color:#065f46">üü¢ Pagado</span>
            </div>
          </div>
          <div id="map-container" style="flex: 1; width: 100%; height: 100%;"></div>
        </div>
    </div>

    <div id="section-configuracion" class="section">
        <div class="card">
        <div class="card-header">Configuraci√≥n</div>
        <p style="color:#64748b; margin-bottom:20px;">Edite este archivo HTML para cambiar las credenciales de Supabase y EmailJS en la variable <code>APP_CONFIG</code>.</p>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="Swal.fire('Info', 'La configuraci√≥n se edita en el c√≥digo fuente.', 'info')">Guardar Cambios</button>
            <button class="btn btn-danger" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        </div>
        </div>
    </div>
    
    </div> 
  </div>
  
    <div id="edit-status-modal" class="modal" onclick="if(event.target.id === 'edit-status-modal') closeEditStatusModal()">
      <div class="modal-content">
          <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
              <span>Modificar Estado de Pago</span>
              <button onclick="closeEditStatusModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
          </div>

          <div style="margin-bottom:20px; background:#f8fafc; padding:15px; border-radius:10px; border:1px solid #e2e8f0;">
              <p style="font-weight:700; margin-bottom:5px;" id="modal-cliente-nombre"></p>
              <p style="font-size:14px; color:#64748b;">Consumo: <span id="modal-consumo-info"></span> | Total: <span id="modal-total-info"></span></p>
          </div>

          <div class="form-group">
              <label for="modal-estado-select">Nuevo Estado de Pago</label>
              <select id="modal-estado-select">
                  <option value="pendiente">Pendiente</option>
                  <option value="pagado">Pagado</option>
                  <option value="mora">Mora</option>
              </select>
          </div>

          <input type="hidden" id="modal-registro-id">

          <div class="btn-group">
              <button class="btn btn-primary" onclick="updateRegistroStatus()" id="btn-update-status">Actualizar Estado</button>
              <button class="btn btn-secondary" onclick="closeEditStatusModal()">Cancelar</button>
          </div>
      </div>
    </div>
  
  <script>
    // ==========================================
    // CONFIGURACI√ìN
    // ==========================================
    const APP_CONFIG = {
      SUPABASE_URL: 'https://nnsqmeigtgewatameexo.supabase.co',
      SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uc3FtZWlndGdld2F0YW1lZXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTkzMzUsImV4cCI6MjA3OTIzNTMzNX0.95GVR7OP46hEj6V6SYfTi4XmEzgB9TrIghR1GewLmOQ',
      EMAILJS_PUBLIC_KEY: 'AaKdY-HQgiru-q-xJ',
      EMAILJS_SERVICE_ID: 'service_663ome3',
      EMAILJS_TEMPLATE_RECIBO: 'template_ow5uddr',
      // REMOVE: MASTER_PASSWORD: 'admin', // Removed for security
      COUNTRY_CODE: '502', // Guatemala
      SESSION_TIMEOUT: 8 * 60 * 60 * 1000, // 8 hours
      MAX_LOGIN_ATTEMPTS: 3,
      LOGIN_LOCKOUT_TIME: 5 * 60 * 1000 // 5 minutes
    };

    // Inicializar Clientes
    const supabaseClient = supabase.createClient(APP_CONFIG.SUPABASE_URL, APP_CONFIG.SUPABASE_KEY);
    emailjs.init(APP_CONFIG.EMAILJS_PUBLIC_KEY);

    // Estado Global
    let clientes = [];
    let registros = [];
    let clienteSeleccionado = null;
    let gpsCoords = null;
    let fotoBase64 = null;
    let rutaActiva = false;
    let rutaIndex = 0;
    let empresa = {};
    let chartInstance = null;
    let mapInstance = null; // Variable global para el mapa
    let currentUserSession = null; // Store current user session

    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });

    // ==========================================
    // INPUT VALIDATION AND XSS PROTECTION
    // ==========================================
    function sanitizeInput(input) {
      return input
        .replace(/[<>]/g, '') // Remove HTML tags
        .replace(/javascript:/gi, '') // Remove javascript protocol
        .replace(/on\w+=/gi, '') // Remove event handlers
        .trim();
    }

    function sanitizeHTML(html) {
      const temp = document.createElement('div');
      temp.textContent = html;
      return temp.innerHTML;
    }

    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email.toLowerCase());
    }

    function validatePhoneNumber(phone) {
      const phoneRegex = /^\d{8}$/; // Guatemala format
      return phoneRegex.test(phone.replace(/\D/g, ''));
    }

    function validateNumber(input, min = 0, max = Infinity) {
      const num = parseFloat(input);
      return !isNaN(num) && num >= min && num <= max;
    }

    // ==========================================
    // SECURITY LOGGING
    // ==========================================
    async function logSecurityEvent(eventType, details) {
      try {
        // Get client IP for security logging
        const clientIP = await getClientIP();

        await supabaseClient.from('security_logs').insert({
          user_id: currentUserSession?.user_id || null,
          event_type: eventType,
          details: details,
          ip_address: clientIP,
          user_agent: navigator.userAgent,
          timestamp: new Date().toISOString()
        });
      } catch (error) {
        console.error('Failed to log security event:', error);
      }
    }

    // IP address detection
    async function getClientIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        return 'unknown';
      }
    }

    // ==========================================
    // L√ìGICA DE NEGOCIO
    // ==========================================
    function calcularTotalPagar(consumo, tarifa, canon) {
        let monto = 0;
        let tipoCobro = "Cero/Error";
        
        if (consumo <= 0.99 && consumo >= 0) {
            monto = parseFloat(canon || 0);
            tipoCobro = "Canon Fijo";
        } else if (consumo > 0.99) {
            monto = parseFloat(consumo) * parseFloat(tarifa || 0);
            tipoCobro = "Consumo";
        }

        return { total: monto, tipo_cobro: tipoCobro };
    }

    // ==========================================
    // LOGIN / LOGOUT
    // ==========================================
    function checkLogin() {
        const sessionData = JSON.parse(sessionStorage.getItem('userSession') || '{}');
        const now = new Date();
        const expiresAt = new Date(sessionData.expires_at);

        if (sessionData.user_id && now < expiresAt) {
            currentUserSession = sessionData;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content-wrapper').style.display = 'block';
            updateUIForRole(sessionData.role);
            return true;
        } else {
            sessionStorage.removeItem('userSession');
            currentUserSession = null;
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-content-wrapper').style.display = 'none';
            return false;
        }
    }

    async function login() {
        const emailInput = document.getElementById('login-email');
        const passwordInput = document.getElementById('login-password');
        const email = sanitizeInput(emailInput.value.trim());
        const password = passwordInput.value;
        const errorMsg = document.getElementById('login-error');

        // Client-side validation
        if (!email || !password) {
            errorMsg.textContent = "Email and password are required";
            errorMsg.style.display = 'block';
            return;
        }

        // Validate email format
        if (!validateEmail(email)) {
            errorMsg.textContent = "Please enter a valid email address";
            errorMsg.style.display = 'block';
            emailInput.focus();
            return;
        }

        // Show loading state
        const loginBtn = document.querySelector('#login-screen button');
        const originalText = loginBtn.innerHTML;
        loginBtn.disabled = true;
        loginBtn.innerHTML = 'Logging in...';

        try {
            // Call secure login function
            const { data, error } = await supabaseClient.rpc('secure_login', {
                email_input: email.toLowerCase(),
                password_input: password,
                ip_address: await getClientIP()
            });

            if (data && data.success) {
                // Store secure session data
                const sessionData = {
                    user_id: data.user_id,
                    email: data.email,
                    name: data.name,
                    role: data.role,
                    login_time: new Date().toISOString(),
                    expires_at: new Date(data.session_expires).toISOString()
                };

                currentUserSession = sessionData;
                sessionStorage.setItem('userSession', JSON.stringify(sessionData));

                // Log successful login
                await logSecurityEvent('login_success', { email: email });

                errorMsg.style.display = 'none';
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content-wrapper').style.display = 'block';

                // Update UI for user role
                updateUIForRole(data.role);

                await cargarDatos();
                actualizarUI();

                Swal.fire({
                    icon: 'success',
                    title: `Welcome back, ${data.name}!`,
                    timer: 2000,
                    showConfirmButton: false
                });

                // Clear form
                emailInput.value = '';
                passwordInput.value = '';
            } else {
                // Log failed login attempt
                await logSecurityEvent('failed_login_attempt', {
                    email: email,
                    reason: data?.message || 'authentication_failed'
                });

                errorMsg.textContent = data?.message || 'Login failed';
                errorMsg.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        } catch (error) {
            console.error('Login error:', error);
            await logSecurityEvent('login_error', { email: email, error: error.message });

            errorMsg.textContent = 'Connection error. Please try again.';
            errorMsg.style.display = 'block';
        } finally {
            loginBtn.disabled = false;
            loginBtn.innerHTML = originalText;
        }
    }
    
    function logout() {
        Swal.fire({
            title: 'Cerrar Sesi√≥n?',
            text: "Tendr√°s que ingresar tus credenciales nuevamente",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'S√≠, salir',
            cancelButtonText: 'Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                // Log session end if user is logged in
                if (currentUserSession) {
                    await logSecurityEvent('logout', {
                        user_id: currentUserSession.user_id,
                        session_duration: Date.now() - new Date(currentUserSession.login_time).getTime()
                    });
                }

                sessionStorage.removeItem('userSession');
                currentUserSession = null;
                window.location.reload();
            }
        });
    }

    // ==========================================
    // SESSION MANAGEMENT
    // ==========================================
    function checkSession() {
        const sessionData = JSON.parse(sessionStorage.getItem('userSession') || '{}');
        const now = new Date();
        const expiresAt = new Date(sessionData.expires_at);

        if (now >= expiresAt) {
            Swal.fire({
                icon: 'warning',
                title: 'Sesi√≥n Expirada',
                text: 'Tu sesi√≥n ha expirado. Por favor inicia sesi√≥n nuevamente.',
                confirmButtonText: 'OK',
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then(() => {
                sessionStorage.removeItem('userSession');
                currentUserSession = null;
                window.location.reload();
            });
            return false;
        }
        return true;
    }

    function updateUIForRole(role) {
        // Hide/show elements based on role
        const adminElements = document.querySelectorAll('.admin-only');
        const operatorElements = document.querySelectorAll('.operator-only');
        const viewerElements = document.querySelectorAll('.viewer-only');

        // Super Admin and Admin see everything
        if (role === 'super_admin' || role === 'admin') {
            adminElements.forEach(el => el.style.display = 'block');
            operatorElements.forEach(el => el.style.display = 'block');
        }
        // Operator sees limited elements
        else if (role === 'operator') {
            adminElements.forEach(el => el.style.display = 'none');
            operatorElements.forEach(el => el.style.display = 'block');
        }
        // Viewer sees only read-only elements
        else if (role === 'viewer') {
            adminElements.forEach(el => el.style.display = 'none');
            operatorElements.forEach(el => el.style.display = 'none');
            viewerElements.forEach(el => el.style.display = 'block');
        }

        // Update header to show current user
        const headerTitle = document.querySelector('.app-title span');
        if (headerTitle && currentUserSession) {
            headerTitle.textContent = `Control de Agua Potable - ${currentUserSession.name}`;
        }
    }

    // Check session every minute
    setInterval(checkSession, 60000);

    // ==========================================
    // INICIALIZACI√ìN
    // ==========================================
    document.addEventListener('DOMContentLoaded', async () => {
        if (checkLogin()) {
            await cargarDatos();
            actualizarUI();
        }
    });

    async function cargarDatos() {
        try {
            const { data: cl, error: ec } = await supabaseClient.from('clientes').select('*');
            if (cl) clientes = cl;
            
            const { data: reg, error: er } = await supabaseClient.from('registros').select('*');
            if (reg) registros = reg;
            
            const { data: emp, error: ee } = await supabaseClient.from('empresa').select('*').limit(1);
            if (emp && emp.length > 0) empresa = emp[0]; else console.warn("No se encontr√≥ configuraci√≥n de empresa.");

            if (ec || er || ee) {
                Swal.fire('Modo Offline', 'No se pudo conectar a la base de datos. Verifique su internet.', 'warning');
            }
        } catch (e) { console.error(e); }
    }

    function actualizarUI() {
        actualizarSelectClientes();
        actualizarListaClientes();
        actualizarTabla();
        actualizarDashboard();
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-'+id).classList.add('active');
        document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
        const targetButton = event.target || document.querySelector(`.nav-tab[onclick*="${id}"]`);
        if(targetButton) targetButton.classList.add('active');

        // Inicializar mapa si es la secci√≥n activa
        if (id === 'mapa') {
            cargarMapa();
        }
    }

    // ==========================================
    // GESTI√ìN DE CLIENTES
    // ==========================================
    async function agregarCliente() {
        const btn = document.getElementById('btn-guardar-cliente');
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.textContent = "Guardando...";

        // Get and validate inputs
        const nombre = sanitizeInput(document.getElementById('nuevo-cliente-nombre').value);
        const codigo = sanitizeInput(document.getElementById('nuevo-cliente-codigo').value);
        const medidor = sanitizeInput(document.getElementById('nuevo-cliente-medidor').value);
        const email = sanitizeInput(document.getElementById('nuevo-cliente-email').value);
        const direccion = sanitizeInput(document.getElementById('nuevo-cliente-direccion').value);
        const telefono = sanitizeInput(document.getElementById('nuevo-cliente-telefono').value);
        const tarifa = parseFloat(document.getElementById('nuevo-cliente-tarifa').value);
        const canon = parseFloat(document.getElementById('nuevo-cliente-canon').value);
        const lecturaInicial = parseFloat(document.getElementById('nuevo-cliente-lectura-inicial').value);

        // Validation
        const errors = [];

        if (!nombre || nombre.length < 2) {
            errors.push('Name must be at least 2 characters');
        }

        if (!codigo || codigo.length < 3) {
            errors.push('Code must be at least 3 characters');
        }

        if (email && !validateEmail(email)) {
            errors.push('Invalid email format');
        }

        if (telefono && !validatePhoneNumber(telefono)) {
            errors.push('Phone must be 8 digits (Guatemala format)');
        }

        if (!validateNumber(tarifa, 0, 1000)) {
            errors.push('Rate must be between 0 and 1000');
        }

        if (!validateNumber(canon, 0, 1000)) {
            errors.push('Fixed fee must be between 0 and 1000');
        }

        if (!validateNumber(lecturaInicial, 0, 999999)) {
            errors.push('Initial reading must be a valid number');
        }

        if (errors.length > 0) {
            Swal.fire('Validation Error', errors.join('\n'), 'error');
            btn.disabled = false; btn.innerHTML = originalText;
            return;
        }

        const nuevo = {
            nombre: nombre,
            codigo: codigo,
            medidor: medidor,
            email: email,
            direccion: direccion,
            telefono: telefono,
            tarifa: tarifa || 0,
            canon: canon || 0,
            lectura_inicial: lecturaInicial || 0
        };

        if(!nuevo.nombre || !nuevo.codigo) {
            Swal.fire('Atenci√≥n', 'Nombre y C√≥digo son obligatorios', 'warning');
            btn.disabled=false; btn.innerHTML=originalText;
            return;
        }

        // Log security event for client creation
        await logSecurityEvent('client_creation_attempt', {
            action: 'create_client',
            client_code: codigo,
            user_role: currentUserSession?.role
        });

        const { data, error } = await supabaseClient.from('clientes').insert(nuevo).select();
        
        if (!error && data) {
            nuevo.id = data[0].id;
            clientes.push(nuevo);
            limpiarFormularioCliente();
            actualizarUI();
            Swal.fire({
                icon: 'success',
                title: 'Cliente Guardado',
                text: 'El cliente se ha registrado exitosamente',
                timer: 2000,
                showConfirmButton: false
            });
        } else {
            Swal.fire('Error', 'No se pudo guardar el cliente. Verifique conexi√≥n.', 'error');
            console.error(error);
        }
        
        btn.disabled = false; btn.innerHTML = originalText;
    }

    function limpiarFormularioCliente() {
        document.querySelectorAll('#section-clientes input').forEach(i => i.value = '');
        document.getElementById('nuevo-cliente-tarifa').value = '3.00';
        document.getElementById('nuevo-cliente-canon').value = '20.00';
        document.getElementById('nuevo-cliente-lectura-inicial').value = '0';
    }

    function actualizarListaClientes() {
        const busqueda = document.getElementById('buscar-cliente').value.toLowerCase();
        const lista = document.getElementById('lista-clientes');
        lista.innerHTML = '';
        
        clientes.filter(c => c.nombre.toLowerCase().includes(busqueda) || c.codigo.toLowerCase().includes(busqueda)).forEach(c => {
            const div = document.createElement('div');
            div.className = 'card';
            div.style.padding = '15px'; div.style.marginBottom = '0';
            div.innerHTML = `
                <div style="font-weight:700">${sanitizeHTML(c.nombre)}</div>
                <div style="font-size:12px; color:#64748b; margin-top:4px;">${sanitizeHTML(c.codigo)} | ${sanitizeHTML(c.medidor)}</div>
                <div style="font-size:12px; color:#0ea5e9; margin-top:4px;">Tarifa: Q${c.tarifa} | Canon: Q${c.canon}</div>
            `;
            lista.appendChild(div);
        });
        document.getElementById('total-clientes').textContent = clientes.length;
    }

    // ==========================================
    // LECTURAS
    // ==========================================
    function actualizarSelectClientes() {
        const sel = document.getElementById('lectura-cliente-select');
        sel.innerHTML = '<option value="">-- Buscar Cliente --</option>';
        clientes.forEach(c => {
            const op = document.createElement('option');
            op.value = c.id; op.textContent = `${c.nombre} (${c.codigo})`;
            sel.appendChild(op);
        });
    }

    function seleccionarClienteLectura() {
        const id = document.getElementById('lectura-cliente-select').value;
        clienteSeleccionado = clientes.find(c => c.id == id); 

        if (!clienteSeleccionado) {
            document.getElementById('lectura-detalles').style.display = 'none';
            return;
        }

        document.getElementById('info-nombre').textContent = clienteSeleccionado.nombre;
        document.getElementById('info-medidor').textContent = clienteSeleccionado.medidor;
        document.getElementById('info-tarifa').textContent = clienteSeleccionado.tarifa;
        document.getElementById('info-canon').textContent = clienteSeleccionado.canon;

        const historial = registros.filter(r => r.cliente_id == clienteSeleccionado.id);
        const ultima = historial.length > 0 
            ? historial.sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0].lectura_actual 
            : clienteSeleccionado.lectura_inicial;

        document.getElementById('info-ultima-lectura').textContent = ultima;
        document.getElementById('lectura-detalles').style.display = 'block';
        
        document.getElementById('lectura-actual').value = '';
        document.getElementById('lectura-consumo').value = '';
        document.getElementById('lectura-monto-est').value = '';
        gpsCoords = null; fotoBase64 = null;
        document.getElementById('gps-display').style.display = 'none';
        document.getElementById('photo-preview').style.display = 'none';
        document.getElementById('photo-placeholder').style.display = 'block';
    }

    function calcularConsumo() {
        if (!clienteSeleccionado) return;
        
        const actualInput = document.getElementById('lectura-actual');
        const consumoInput = document.getElementById('lectura-consumo');
        const montoInput = document.getElementById('lectura-monto-est');

        const actual = parseFloat(actualInput.value);
        const anterior = parseFloat(document.getElementById('info-ultima-lectura').textContent);
        
        if (!isNaN(actual)) {
            const consumo = actual - anterior;
            
            // VALIDACI√ìN VISUAL
            if (consumo < 0) {
                consumoInput.value = consumo.toFixed(2) + " (ERROR)";
                consumoInput.style.color = '#dc2626';
                consumoInput.style.fontWeight = 'bold';
                montoInput.value = "Q0.00 (Inv√°lido)";
                actualInput.style.borderColor = '#dc2626';
                return;
            }

            consumoInput.style.color = '#0ea5e9';
            actualInput.style.borderColor = '#e2e8f0';
            consumoInput.value = consumo.toFixed(2);
            
            const tarifa = clienteSeleccionado.tarifa;
            const canon = clienteSeleccionado.canon;
            
            let resultado = { total: 0, tipo_cobro: 'N/A' };
            if (consumo >= 0) {
                resultado = calcularTotalPagar(consumo, tarifa, canon);
            }
            
            montoInput.value = `Q${resultado.total.toFixed(2)} (${resultado.tipo_cobro})`;
        } else {
            consumoInput.value = '';
            montoInput.value = '';
            actualInput.style.borderColor = '#e2e8f0';
        }
    }

    function obtenerGPS() {
        const btn = document.getElementById('btn-gps');
        btn.textContent = "Buscando..."; btn.disabled = true;
        navigator.geolocation.getCurrentPosition(pos => {
            gpsCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            document.getElementById('gps-display').style.display = 'block';
            document.getElementById('gps-display').textContent = `‚úÖ ${gpsCoords.lat.toFixed(5)}, ${gpsCoords.lng.toFixed(5)}`;
            btn.textContent = "GPS Listo"; btn.disabled = false;
        }, err => { 
            Swal.fire('Error GPS', err.message, 'error');
            btn.textContent = "Reintentar GPS"; btn.disabled = false; 
        });
    }

    function handlePhoto(e) {
        const f = e.target.files[0];
        if (f) {
            const r = new FileReader();
            r.onload = (ev) => {
                fotoBase64 = ev.target.result;
                const img = document.getElementById('photo-preview');
                img.src = fotoBase64; img.style.display = 'block';
                document.getElementById('photo-placeholder').style.display = 'none';
            };
            r.readAsDataURL(f);
        }
    }

    async function agregarLectura() {
        if (!clienteSeleccionado) return Swal.fire('Atenci√≥n', 'Seleccione un cliente primero', 'warning');
        
        const actual = parseFloat(document.getElementById('lectura-actual').value);
        const consumo = parseFloat(document.getElementById('lectura-consumo').value);
        
        if (isNaN(actual) || isNaN(consumo)) return Swal.fire('Error', 'Los datos de la lectura son inv√°lidos', 'error');
        
        if (consumo < 0) {
            Swal.fire('Consumo Negativo', 'La lectura actual debe ser mayor o igual a la anterior.', 'error');
            document.getElementById('lectura-actual').focus();
            return;
        }

        const btn = document.getElementById('btn-guardar-lectura');
        const txt = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = "Guardando...";

        const resultadoCobro = calcularTotalPagar(consumo, clienteSeleccionado.tarifa, clienteSeleccionado.canon);

        const registro = {
            cliente_id: clienteSeleccionado.id,
            cliente_nombre: clienteSeleccionado.nombre,
            fecha: new Date().toISOString(),
            lectura_anterior: parseFloat(document.getElementById('info-ultima-lectura').textContent),
            lectura_actual: actual,
            consumo: consumo,
            tarifa_aplicada: clienteSeleccionado.tarifa,
            canon_aplicado: clienteSeleccionado.canon,
            monto_calculado: resultadoCobro.total,
            tipo_cobro: resultadoCobro.tipo_cobro,
            estado: document.getElementById('lectura-estado').value,
            mes: document.getElementById('lectura-mes').value,
            notas: document.getElementById('lectura-notas').value,
            gps: gpsCoords,
            foto: fotoBase64
        };

        const { data, error } = await supabaseClient.from('registros').insert(registro).select();

        if (!error) {
            const nuevoRegistro = data[0];
            registros.push(nuevoRegistro);
            
            if (clienteSeleccionado.email) {
                enviarReciboEmail(clienteSeleccionado.email, nuevoRegistro);
            }

            Swal.fire({
                icon: 'success',
                title: 'Lectura Guardada',
                text: '¬øDeseas enviar el recibo por WhatsApp?',
                showCancelButton: true,
                confirmButtonColor: '#25D366',
                cancelButtonColor: '#64748b',
                confirmButtonText: '<i class="fa fa-whatsapp"></i> Enviar WhatsApp',
                cancelButtonText: 'No, gracias'
            }).then((result) => {
                if (result.isConfirmed) {
                    enviarWhatsApp(nuevoRegistro);
                }
                
                if (rutaActiva) {
                    rutaIndex++;
                    if (rutaIndex < clientes.length) {
                        cargarRuta();
                    } else {
                        Swal.fire('Ruta Finalizada', '¬°Has completado todas las lecturas!', 'info');
                        toggleRuta();
                    }
                } else {
                    limpiarFormularioLectura();
                    actualizarUI();
                }
            });

        } else {
            Swal.fire('Error', 'No se pudo guardar en la base de datos', 'error');
            console.error(error);
            btn.disabled = false; btn.innerHTML = txt;
        }
    }

    function limpiarFormularioLectura() {
        document.getElementById('lectura-cliente-select').value = '';
        document.getElementById('lectura-detalles').style.display = 'none';
        clienteSeleccionado = null;
        window.scrollTo(0,0);
        const btn = document.getElementById('btn-guardar-lectura');
        btn.disabled = false; btn.textContent = "üíæ Guardar Lectura";
    }

    // ==========================================
    // RUTA
    // ==========================================
    function toggleRuta() {
        rutaActiva = !rutaActiva;
        const status = document.getElementById('route-status-text');
        const btn = document.getElementById('btn-ruta');
        
        if (rutaActiva) {
            status.textContent = "Modo Ruta ACTIVO";
            btn.textContent = "Detener Ruta";
            rutaIndex = 0;
            cargarRuta();
            Toast.fire({ icon: 'info', title: 'Modo Ruta Iniciado' });
        } else {
            status.textContent = "Modo Manual";
            btn.textContent = "Iniciar Ruta";
            limpiarFormularioLectura();
        }
    }

    function cargarRuta() {
        const cliente = clientes[rutaIndex];
        if (cliente) {
            document.getElementById('lectura-cliente-select').value = cliente.id;
            seleccionarClienteLectura();
            document.getElementById('route-status-text').textContent = `Ruta: Cliente ${rutaIndex + 1} de ${clientes.length}`;
        }
    }

    // ==========================================
    // TABLAS Y REPORTES
    // ==========================================
    function aplicarFiltros() {
        actualizarTabla(); 
    }

    function actualizarTabla() {
        const tbody = document.querySelector('#tabla-registros tbody');
        tbody.innerHTML = '';
        
        const txt = document.getElementById('filtro-texto').value.toLowerCase();
        const est = document.getElementById('filtro-estado').value;

        const filtrados = registros.filter(r => {
            const matchTxt = (r.cliente_nombre || '').toLowerCase().includes(txt);
            const matchEst = est ? r.estado === est : true;
            return matchTxt && matchEst;
        }).sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

        filtrados.forEach(r => {
            const total = r.monto_calculado || calcularTotalPagar(r.consumo, r.tarifa_aplicada, r.canon_aplicado || 20).total;
            
            const acciones = `
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-warning" style="padding: 6px 10px; font-size:12px;" onclick="openEditStatusModal('${r.id}')">‚úèÔ∏è</button>
                    <button class="btn btn-whatsapp" style="padding: 6px 10px; font-size:12px;" onclick="enviarWhatsAppManual('${r.id}')">üì±</button>
                </div>
            `;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${new Date(r.fecha).toLocaleDateString()}</td>
                <td>${r.cliente_nombre}</td>
                <td>${r.lectura_anterior}</td>
                <td>${r.lectura_actual}</td>
                <td><strong>${r.consumo.toFixed(2)}</strong></td>
                <td>Q${total.toFixed(2)}</td>
                <td><span class="status-pill status-${r.estado}">${r.estado}</span></td>
                <td>${acciones}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ==========================================
    // WHATSAPP
    // ==========================================
    function enviarWhatsAppManual(registroId) {
        const registro = registros.find(r => r.id == registroId);
        if(registro) enviarWhatsApp(registro);
    }

    function enviarWhatsApp(registro) {
        const cliente = clientes.find(c => c.id == registro.cliente_id);
        let telefono = cliente ? cliente.telefono : '';

        if (!telefono) {
            Swal.fire('Sin Tel√©fono', 'Este cliente no tiene un n√∫mero de tel√©fono registrado.', 'warning');
            return;
        }

        telefono = telefono.replace(/[^0-9]/g, '');

        if (telefono.length === 8) {
            telefono = APP_CONFIG.COUNTRY_CODE + telefono;
        }

        const total = registro.monto_calculado || calcularTotalPagar(registro.consumo, registro.tarifa_aplicada, registro.canon_aplicado).total;

        const mensaje = `Hola ${registro.cliente_nombre}, su recibo de agua potable:
üìÖ Fecha: ${new Date(registro.fecha).toLocaleDateString()}
üíß Lectura Actual: ${registro.lectura_actual}
üìä Consumo: ${registro.consumo.toFixed(2)} m¬≥
üí∞ Total a Pagar: Q${total.toFixed(2)}
‚ÑπÔ∏è Estado: ${registro.estado.toUpperCase()}

Gracias por su pago puntual.`;

        const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
        window.open(url, '_blank');
    }

    // ==========================================
    // MAPA (LEAFLET)
    // ==========================================
    function cargarMapa() {
        if (!document.getElementById('section-mapa').classList.contains('active')) return;
        
        setTimeout(() => {
            if (mapInstance) {
                mapInstance.invalidateSize(); 
                return;
            }

            mapInstance = L.map('map-container').setView([14.6349, -90.5069], 13); // Default Guatemala

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(mapInstance);

            actualizarPinesMapa();
        }, 200);
    }

    function actualizarPinesMapa() {
        if (!mapInstance) return;

        mapInstance.eachLayer((layer) => {
            if (layer instanceof L.Marker) {
                mapInstance.removeLayer(layer);
            }
        });

        const markers = [];

        clientes.forEach(cliente => {
            const lecturasCliente = registros
                .filter(r => r.cliente_id === cliente.id && r.gps)
                .sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

            if (lecturasCliente.length > 0) {
                const ultima = lecturasCliente[0];
                const { lat, lng } = ultima.gps;

                let colorPin = 'blue';
                if (ultima.estado === 'mora') colorPin = 'red';
                else if (ultima.estado === 'pendiente') colorPin = 'gold';
                else if (ultima.estado === 'pagado') colorPin = 'green';
                
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color:${colorPin}; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [15, 15],
                    iconAnchor: [7, 7]
                });

                const marker = L.marker([lat, lng], { icon: customIcon }).addTo(mapInstance);
                
                marker.bindPopup(`
                    <strong>${cliente.nombre}</strong><br>
                    Estado: <b style="color:${colorPin}">${ultima.estado.toUpperCase()}</b><br>
                    Consumo: ${ultima.consumo} m¬≥<br>
                    <small>${new Date(ultima.fecha).toLocaleDateString()}</small><br>
                    <button class="btn btn-primary" style="padding:2px 8px; font-size:10px; margin-top:5px" onclick="enviarWhatsAppManual('${ultima.id}')">WhatsApp</button>
                `);

                markers.push([lat, lng]);
            }
        });

        if (markers.length > 0) {
            const bounds = L.latLngBounds(markers);
            mapInstance.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    // ==========================================
    // MODAL DE EDICI√ìN DE ESTADO
    // ==========================================
    function openEditStatusModal(registroId) {
        const registro = registros.find(r => r.id == registroId);
        if (!registro) return Swal.fire('Error', 'Registro no encontrado', 'error');
        
        const total = registro.monto_calculado || calcularTotalPagar(registro.consumo, registro.tarifa_aplicada, registro.canon_aplicado || 20).total;

        document.getElementById('modal-registro-id').value = registro.id;
        document.getElementById('modal-cliente-nombre').textContent = registro.cliente_nombre;
        document.getElementById('modal-consumo-info').textContent = `${registro.consumo.toFixed(2)} m¬≥`;
        document.getElementById('modal-total-info').textContent = `Q${total.toFixed(2)}`;
        document.getElementById('modal-estado-select').value = registro.estado;

        document.getElementById('edit-status-modal').classList.add('active');
    }

    function closeEditStatusModal() {
        document.getElementById('edit-status-modal').classList.remove('active');
    }

    async function updateRegistroStatus() {
        const registroId = document.getElementById('modal-registro-id').value;
        const nuevoEstado = document.getElementById('modal-estado-select').value;
        
        if (!registroId || !nuevoEstado) return;

        const btn = document.getElementById('btn-update-status');
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.textContent = "Guardando...";

        const { data, error } = await supabaseClient
            .from('registros')
            .update({ estado: nuevoEstado })
            .eq('id', registroId)
            .select();

        if (!error) {
            const index = registros.findIndex(r => r.id == registroId);
            if (index !== -1) {
                registros[index].estado = nuevoEstado;
            }

            closeEditStatusModal();
            actualizarUI(); 
            Swal.fire({
                icon: 'success',
                title: 'Actualizado',
                text: 'Estado de pago modificado correctamente',
                timer: 1500,
                showConfirmButton: false
            });
        } else {
            Swal.fire('Error', 'No se pudo actualizar el estado', 'error');
            console.error(error);
        }
        
        btn.disabled = false; btn.innerHTML = originalText;
    }


    // ==========================================
    // DASHBOARD
    // ==========================================
    function actualizarDashboard() {
        const hoy = new Date();
        const mes = registros.filter(r => new Date(r.fecha).getMonth() === hoy.getMonth());
        
        const consumoTotal = mes.reduce((acc, r) => acc + (parseFloat(r.consumo)||0), 0);
        
        const recaudoTotal = mes.reduce((acc, r) => {
            const monto = r.monto_calculado || calcularTotalPagar(r.consumo, r.tarifa_aplicada, r.canon_aplicado || 20).total;
            return acc + monto;
        }, 0);

        const pendientes = registros.filter(r => r.estado === 'pendiente').length;

        document.getElementById('dash-consumo').textContent = consumoTotal.toFixed(2);
        document.getElementById('dash-dinero').textContent = recaudoTotal.toFixed(2);
        document.getElementById('dash-pendientes').textContent = pendientes;

        const mesesNombres = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        const dataConsumo = [];
        const labelsMeses = [];
        
        for (let i = 5; i >= 0; i--) {
            const d = new Date();
            d.setMonth(d.getMonth() - i);
            const mes_idx = d.getMonth();
            const anio = d.getFullYear();
            
            labelsMeses.push(`${mesesNombres[mes_idx]} ${anio}`);
            
            const suma = registros.filter(r => {
                const fr = new Date(r.fecha);
                return fr.getMonth() === mes_idx && fr.getFullYear() === anio;
            }).reduce((acc, curr) => acc + curr.consumo, 0);
            
            dataConsumo.push(suma);
        }
        
        const ctx = document.getElementById('chart-consumo');
        if (chartInstance) chartInstance.destroy();
        
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labelsMeses,
                datasets: [{
                    label: 'Consumo (m¬≥)',
                    data: dataConsumo,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true },
                    x: { }
                }
            }
        });
    }

    // ==========================================
    // GENERAR PDF BASE64
    // ==========================================
    function generarReciboPDFBase64(registro) {
        const doc = new jspdf.jsPDF();
        const total = registro.monto_calculado.toFixed(2);
        const fecha = new Date(registro.fecha).toLocaleDateString();
        const nombreEmpresa = empresa.nombre || 'Control de Consumo de Agua';

        doc.setFontSize(16);
        doc.text(nombreEmpresa, 14, 15);
        doc.setFontSize(12);
        doc.text("Recibo de Consumo de Agua Potable", 14, 22);

        doc.setFontSize(10);
        doc.text(`Cliente: ${registro.cliente_nombre}`, 14, 32);
        doc.text(`Fecha de Lectura: ${fecha}`, 14, 37);
        doc.text(`Tipo de Cobro: ${registro.tipo_cobro}`, 14, 42);

        const head = [['Concepto', 'Lectura/Tarifa', 'Detalle']];
        const body = [
            ['Lectura Anterior (m¬≥)', registro.lectura_anterior, ''],
            ['Lectura Actual (m¬≥)', registro.lectura_actual, ''],
            ['Consumo (m¬≥)', registro.consumo.toFixed(2), ''],
            ['Tarifa Aplicada (Q/m¬≥)', `Q${registro.tarifa_aplicada.toFixed(2)}`, ''],
            ['Canon Fijo (Q)', `Q${registro.canon_aplicado.toFixed(2)}`, ''],
            ['Monto TOTAL a Pagar (Q)', '', `Q${total}`]
        ];
        
        doc.autoTable({
            startY: 48,
            head: head,
            body: body,
            theme: 'striped',
            styles: { fontSize: 9 },
            headStyles: { fillColor: [14, 165, 233] },
            didDrawCell: (data) => {
                if (data.row.index === body.length - 1 && data.cell.section === 'body') {
                    doc.setFillColor(212, 237, 218); 
                    doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                }
            }
        });
        
        let finalY = doc.autoTable.previous.finalY;
        if (registro.notas) {
            doc.setFontSize(10);
            doc.text(`Notas: ${registro.notas}`, 14, finalY + 10);
        }
        
        const pdfDataUri = doc.output('datauristring');
        return pdfDataUri.split(',')[1]; 
    }

    // ==========================================
    // EMAILS (Adjunto Foto + PDF)
    // ==========================================
    function enviarReciboEmail(email, registro) {
        const total = registro.monto_calculado;
        const fullDataUrl = registro.foto; 

        let base64DataFoto = null;
        let fileExtension = 'jpg';

        if (fullDataUrl) {
            const parts = fullDataUrl.split(',');
            if (parts.length === 2) {
                base64DataFoto = parts[1];
                const mimePart = parts[0].match(/:(.*?);/);
                if (mimePart && mimePart[1]) {
                    const mimeType = mimePart[1];
                    if (mimeType.includes('png')) fileExtension = 'png';
                    else if (mimeType.includes('jpeg') || mimeType.includes('jpg')) fileExtension = 'jpg';
                    else if (mimeType.includes('heic')) fileExtension = 'heic';
                }
            }
        }
        
        const adjunto_final = base64DataFoto 
            ? `Foto_Medidor_${registro.cliente_nombre.replace(/\s/g, '_')}_${new Date().getTime()}.${fileExtension}|${base64DataFoto}` 
            : null;

        const pdfBase64Data = generarReciboPDFBase64(registro);
        const pdf_adjunto_final = pdfBase64Data 
            ? `Recibo_${registro.cliente_nombre.replace(/\s/g, '_')}_${new Date().getTime()}.pdf|${pdfBase64Data}` 
            : null;
        
        const params = {
            to_email: email,
            nombre_cliente: registro.cliente_nombre,
            lectura_actual: registro.lectura_actual,
            lectura_anterior: registro.lectura_anterior,
            consumo: registro.consumo,
            total_pagar: total.toFixed(2),
            fecha: new Date().toLocaleDateString(),
            nombre_empresa: empresa.nombre || 'Control de Consumo de Agua',
            tipo_cobro: registro.tipo_cobro,
            foto_adjunta: adjunto_final, 
            pdf_adjunto: pdf_adjunto_final 
        };
        
        emailjs.send(APP_CONFIG.EMAILJS_SERVICE_ID, APP_CONFIG.EMAILJS_TEMPLATE_RECIBO, params)
            .then(() => Toast.fire({ icon: 'success', title: 'Correo enviado' }))
            .catch(err => console.error("Error Email", err));
    }
    
    function exportarPDFGlobal() {
        const doc = new jspdf.jsPDF();
        doc.text("Reporte de Lecturas", 14, 20);
        doc.autoTable({ html: '#tabla-registros', startY: 30 });
        doc.save('reporte_agua.pdf');
    }
  </script>
 </body>
</html>
